<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.mytijian.mediator.common.DAO.UpgradeMessageMapper">

	<resultMap id="UpgradeLogMap" type="com.mytijian.mediator.api.model.UpgradeMessage">
		<id property="id" column="id"/>
		<result property="hospitalId" column="hospital_id" />
		<result property="currentVersion" column="curr_version" />
		<result property="newVersion" column="new_version" />
		<result property="packFile" column="package_file"/>
		<result property="status" column="status"/>
		<result property="upgradeTime" column="upgrade_time"/>
	</resultMap>
	
	<sql id="columns">
		id,
		hospital_id,
		curr_version,
		new_version,
		package_file,
		status,
		upgrade_time
	</sql>
	
	<select id="selectById" resultMap="UpgradeLogMap">
		select <include refid="columns"/>
		from 
			tb_upgrade_message
		where 
			id = #{id}
	</select>
	
	<select id="selectByHospitalId" resultMap="UpgradeLogMap">
		select <include refid="columns"/>
		from 
			tb_upgrade_message
		where 
			status = 0
			and hospital_id = #{hospitalId} limit 1
	</select>
	
	<update id="updateStatus">
		update 
			tb_upgrade_message
		set
			status = #{status},
			upgrade_time = now()
		where 
			id = #{id}
	</update>
	
	<insert id="insert" parameterType="com.mytijian.mediator.api.model.UpgradeMessage">
		<selectKey keyProperty="message.id" order="BEFORE" resultType="Integer">
			select nextval('tb_upgrade_message_seq')
		</selectKey>
		insert into tb_upgrade_message(<include refid="columns"/>)
		values (#{message.id},
				#{message.hospitalId},
				#{message.currentVersion},
				#{message.newVersion},
				#{message.packFile},
				#{message.status},
				now())		
	</insert>
	
	<select id="selectOneOrderByTime" resultMap="UpgradeLogMap">
		select <include refid="columns"/>
		from 
			tb_upgrade_message
		where 
			 hospital_id = #{hospitalId}
		order by 
			upgrade_time desc limit 1
	</select>
</mapper>